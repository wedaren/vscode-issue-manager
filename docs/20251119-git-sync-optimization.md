# Git自动同步机制优化：解决本地更改导致的同步失败

## 1. 问题背景

用户在使用 Git 自动同步功能时遇到报错：
```
[ERROR] [Git同步] 存在合并冲突，需要手动解决
```

查看详细日志发现，实际错误并非真正的代码冲突，而是 Git 的保护机制：
```
Error: Your local changes to the following files would be overwritten by merge:
    .issueManager/file-access-stats.json
Please commit your changes or stash them before you merge.
```

**原因分析**：
原有的同步流程是 **先拉取 (Pull) -> 后提交 (Commit)**。
当本地有未提交的修改时，`git pull` 为了防止覆盖这些修改，会直接报错并终止操作。这导致用户必须手动介入（提交或贮藏更改），违背了"自动同步"的设计初衷。

## 2. 解决思路

### 方案一：优化错误提示（已尝试但被优化）
最初的方案是捕获此类特定错误，并弹窗引导用户："检测到本地有未提交的更改，请先提交或贮藏"。
*   **优点**：逻辑简单，风险小。
*   **缺点**：打断用户心流，需要用户手动操作，体验不佳。
*   **用户反馈**：希望避免此类提示，实现完全的自动化同步。

### 方案二：调整同步工作流（最终决策）
为了实现"无感同步"，我们需要调整 Git 操作的顺序，采用 **先提交 (Commit) -> 后拉取 (Pull)** 的策略。

**新流程逻辑**：
1.  **检查本地更改**：如果有未提交的文件，先执行 `git commit`。
    *   这一步将"未提交的更改"转变为"本地提交"，消除了 `git pull` 覆盖文件的风险。
2.  **拉取远程更新**：执行 `git pull`。
    *   此时 Git 会自动尝试合并远程分支和本地分支。
    *   如果是简单的更新，Git 会自动完成合并（Merge）。
    *   只有在真正的代码行冲突时，才会抛出需要人工解决的冲突错误。
3.  **推送更改**：如果执行了提交，或者拉取操作产生了合并提交，则执行 `git push`。

## 3. 实施细节

### 代码重构
1.  **`GitOperations.ts`**
    *   将原有的 `commitAndPushChanges` 方法拆解为 `commitChanges` 和 `pushChanges`，提供更细粒度的控制能力。

2.  **`GitSyncService.ts`**
    *   **自动同步 (`performAutoCommitAndPush`)**：
        *   改为：`Check & Commit` -> `Pull` -> `Push`。
    *   **周期性拉取 (`performPull`)**：
        *   原逻辑仅执行 `Pull`，如果用户正在编辑文件会导致失败。
        *   新逻辑同样引入了自动提交机制：在拉取前检查并提交本地更改，确保后台同步任务不会因用户正在编辑而失败。

## 4. 最终效果

通过此次优化，插件的 Git 同步功能变得更加健壮和智能：
*   **消除误报**：不再将"本地未提交更改"误报为"合并冲突"。
*   **无感体验**：用户无需手动提交更改，插件会自动保存并处理合并。
*   **持续同步**：即使在用户频繁编辑期间，后台的周期性同步也能正常工作，保证数据实时性。
