# 编辑器事件管理器重构

## 背景

之前在代码中有**三处**监听 `vscode.window.onDidChangeActiveTextEditor` 事件：

1. `FileAccessTracker.ts` - 用于记录文件访问统计
2. `relatedIssuesViewRegistration.ts` - 用于自动更新相关联问题视图
3. `IssueStructureProvider.ts` - 用于根据当前文件构建问题结构树

这种重复订阅不仅浪费资源，也不利于代码维护。

## 解决方案

创建了 `EditorEventManager` 服务来统一管理编辑器相关的事件监听，采用观察者模式，允许多个模块订阅同一个事件。

### 架构设计

```
EditorEventManager (单例)
    ↓ 监听一次 onDidChangeActiveTextEditor
    ↓ 检查是否为 Issue Markdown 文件
    ↓
    ├─→ 通知 FileAccessTracker (记录访问统计)
    ├─→ 通知 RelatedIssuesProvider (更新视图)
    └─→ 通知 IssueStructureProvider (构建结构树)
```

## 实现细节

### 1. 创建 EditorEventManager 服务

**文件**: `src/services/EditorEventManager.ts`

主要功能：
- 使用单例模式，确保全局只有一个实例
- 统一监听 `onDidChangeActiveTextEditor` 事件
- 使用 `isIssueMarkdownFile()` 过滤 Issue Markdown 文件
- 提供 `onIssueFileActivated()` 方法供其他模块订阅
- 支持动态订阅和取消订阅

```typescript
export class EditorEventManager implements vscode.Disposable {
    private issueFileActivatedHandlers: Array<(uri: vscode.Uri) => void> = [];

    public onIssueFileActivated(handler: (uri: vscode.Uri) => void): vscode.Disposable {
        // 添加订阅者
        this.issueFileActivatedHandlers.push(handler);
        
        // 返回 Disposable，允许取消订阅
        return {
            dispose: () => {
                const index = this.issueFileActivatedHandlers.indexOf(handler);
                if (index > -1) {
                    this.issueFileActivatedHandlers.splice(index, 1);
                }
            }
        };
    }
}
```

### 2. 修改 FileAccessTracker

**变更**:
- 移除了自己的 `onDidChangeActiveTextEditor` 监听器
- 改为订阅 `EditorEventManager.onIssueFileActivated()` 事件

```typescript
private setupEventListeners(): void {
    // 订阅编辑器事件管理器的 Issue 文件激活事件
    const editorEventManager = EditorEventManager.getInstance();
    const subscription = editorEventManager.onIssueFileActivated((uri) => {
        this.recordFileAccess(uri.fsPath);
    });
    this.disposables.push(subscription);
}
```

### 3. 修改 relatedIssuesViewRegistration

**变更**:
- 移除了自己的 `onDidChangeActiveTextEditor` 监听器
- 改为订阅 `EditorEventManager.onIssueFileActivated()` 事件
- 保持了视图锁定功能的逻辑

```typescript
// 订阅编辑器事件管理器，自动更新相关联问题视图
const editorEventManager = EditorEventManager.getInstance();
const subscription = editorEventManager.onIssueFileActivated((uri) => {
    // 只在视图未锁定时自动更新
    if (!isPinned) {
        relatedIssuesProvider.updateContext(uri);
    }
});
context.subscriptions.push(subscription);
```

### 4. 修改 IssueStructureProvider

**变更**:
- 移除了自己的 `onDidChangeActiveTextEditor` 监听器
- 改为订阅 `EditorEventManager.onIssueFileActivated()` 事件
- 重构了 `onActiveEditorChanged` 方法为 `onIssueFileActivated`，接收 URI 参数
- 移除了冗余的文件类型和路径检查（已由 `isIssueMarkdownFile` 统一处理）

```typescript
constructor(private context: vscode.ExtensionContext) {
    // 订阅编辑器事件管理器的 Issue 文件激活事件
    const editorEventManager = EditorEventManager.getInstance();
    const subscription = editorEventManager.onIssueFileActivated((uri) => {
        this.onIssueFileActivated(uri);
    });
    this.context.subscriptions.push(subscription);
    
    // ...
}

private async onIssueFileActivated(uri: vscode.Uri): Promise<void> {
    const frontmatter = await getFrontmatter(uri);
    if (!frontmatter || !frontmatter.root_file) {
        this.showGuidanceMessage();
        return;
    }
    // ...
}
```

### 5. 在 ServiceRegistry 中初始化

**变更**:
- 在 `initializeServices()` 方法中，最先初始化 `EditorEventManager`
- 确保其他依赖编辑器事件的服务能够正常订阅

```typescript
public initializeServices(): void {
    try {
        // 0. 初始化编辑器事件管理器（基础服务，其他服务依赖它）
        this.initializeEditorEventManager();
        
        // 1. 初始化Git同步服务（核心功能）
        this.initializeGitSyncService();
        
        // 2. 初始化文件访问跟踪服务（性能监控）
        this.initializeFileAccessTracker();
        
        // ...
    }
}
```

## 优势

### 1. 性能优化
- **避免重复监听**: 只在系统层面监听一次 `onDidChangeActiveTextEditor` 事件（从 3 个减少到 1 个）
- **统一过滤**: 只执行一次 `isIssueMarkdownFile()` 检查
- **减少事件处理开销**: 事件触发时只有一个监听器响应，然后通知订阅者

### 2. 代码维护性
- **职责清晰**: 编辑器事件管理集中在一处
- **易于扩展**: 新的模块可以轻松订阅编辑器事件，无需重复实现监听逻辑
- **解耦合**: 各个模块不直接依赖 VS Code 的编辑器事件 API
- **代码复用**: 消除了 `IssueStructureProvider` 中冗余的文件类型和路径检查

### 3. 资源管理
- **统一生命周期**: 所有订阅都通过 `context.subscriptions` 管理
- **支持取消订阅**: 返回 `Disposable` 对象，允许动态取消订阅

## 扩展性

如果将来需要添加更多编辑器相关的事件监听（如文档保存、文档关闭等），可以在 `EditorEventManager` 中统一添加，避免在多个模块中重复实现。

例如：
```typescript
// 未来可以添加的事件
public onIssueFileModified(handler: (uri: vscode.Uri) => void): vscode.Disposable
public onIssueFileClosed(handler: (uri: vscode.Uri) => void): vscode.Disposable
public onIssueFileSaved(handler: (uri: vscode.Uri) => void): vscode.Disposable
```

## 相关文件

- `src/services/EditorEventManager.ts` - 编辑器事件管理器（新增）
- `src/services/FileAccessTracker.ts` - 文件访问跟踪服务（修改）
- `src/views/relatedIssuesViewRegistration.ts` - 相关问题视图注册（修改）
- `src/views/IssueStructureProvider.ts` - 问题结构视图提供者（修改）
- `src/core/ServiceRegistry.ts` - 服务注册管理器（修改）

## 实现日期

2025年10月24日
