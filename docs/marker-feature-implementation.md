# 问题标记功能实现文档

## 功能概述

问题标记功能允许用户在编码过程中快速创建标记点，用于追踪需要关注的位置、记录工作进度或标注重要代码段。

## 核心功能

### 1. 快速创建标记

- **快捷键**: `cmd+j cmd+g` (macOS) / `ctrl+j ctrl+g` (Windows/Linux)
- **行为**: 
  - 弹出输入框，默认填充下一个序号（如当前最大序号为 3，则填充 4）
  - 用户可以快速按回车使用默认序号，或输入自定义文本
  - 自动记录当前编辑器的文件路径、行号和列号（如果有活动编辑器）

### 2. TreeView 结构

#### 当前标记任务合集（第一项）
- **展开状态**: 默认展开
- **显示信息**: 显示标记数量（如"5 个标记"）
- **功能**:
  - 可展开查看所有子标记项
  - 支持拖动排序标记项
  - 如果标记为默认序号，拖动后自动更新序号
  - 支持批量删除所有标记

#### 归档任务项（第二项、第三项等）
- **展开状态**: 默认折叠
- **显示信息**: 显示任务标题和标记数量
- **功能**:
  - 只读展示，不可编辑或删除子项
  - 支持删除整个归档任务
  - 支持填充到当前任务

### 3. 标记项功能

#### 当前任务中的标记项
- **显示内容**: 标记文本 + 文件位置（如 "1 file.ts:10"）
- **功能**:
  - 点击跳转到对应位置
  - 支持拖动排序
  - 支持重命名
  - 支持单个删除
  - 支持关联到问题（占位功能）

#### 归档任务中的标记项
- **显示内容**: 标记文本 + 文件位置
- **功能**:
  - 点击跳转到对应位置（只读）
  - 不可移动、不可删除、不可编辑

### 4. 任务操作

#### 归档当前任务
- **触发**: 点击视图标题栏的归档按钮
- **行为**:
  1. 检查当前任务是否为空，为空则提示
  2. 弹出输入框要求输入归档任务标题
  3. 将当前任务的所有标记复制到新的归档任务
  4. 归档任务插入到列表开头（最新的在最上面）
  5. 清空当前任务

#### 清空当前任务
- **触发**: 点击视图标题栏的清空按钮
- **行为**:
  1. 检查当前任务是否为空
  2. 显示确认对话框
  3. 确认后清空所有标记

#### 删除归档任务
- **触发**: 点击归档任务项的删除按钮
- **行为**:
  1. 显示确认对话框
  2. 确认后从列表中删除该归档任务

#### 填充归档任务
- **触发**: 点击归档任务项的填充按钮
- **行为**:
  1. 检查当前任务是否为空
  2. 如果不为空，显示确认对话框询问是否替换
  3. 将归档任务的所有标记复制到当前任务

### 5. 关联功能（占位）

- **显示图标**: 
  - 未关联: `$(link)` 图标
  - 已关联: `$(go-to-file)` 图标
- **触发位置**: 
  - 每个任务项（当前任务、归档任务）
  - 每个标记项（当前标记、归档标记）
- **当前行为**: 显示"关联功能即将推出"提示
- **计划功能**: 将标记或任务关联到特定的问题（Issue）

## 数据存储

### 存储位置
- 使用 VS Code 的 `globalStorageUri` 存储数据
- 文件路径: `<globalStorageUri>/markers.json`

### 数据结构

```typescript
{
  "currentTask": {
    "title": "当前标记任务合集",
    "markers": [
      {
        "message": "1",
        "filePath": "/path/to/file.ts",
        "line": 10,
        "column": 5,
        "createdAt": 1234567890,
        "associatedIssueId": "issue-123"  // 可选
      }
    ],
    "createdAt": 1234567890,
    "associatedIssueId": "issue-456"  // 可选
  },
  "archivedTasks": [
    {
      "title": "重构用户模块",
      "markers": [...],
      "createdAt": 1234567890,
      "associatedIssueId": "issue-789"  // 可选
    }
  ]
}
```

## 技术实现

### 核心文件

1. **MarkerManager.ts**
   - 标记的创建、删除、重命名、移动等核心逻辑
   - 数据的加载和保存
   - 任务的归档、清空、填充等操作

2. **MarkerTreeProvider.ts**
   - TreeView 的数据提供者
   - 实现拖放功能（TreeDragAndDropController）
   - 节点的展示和交互

3. **MarkerCommandHandler.ts**
   - 所有命令的注册和处理
   - 连接用户操作和 MarkerManager

### 集成点

- **ViewRegistry.ts**: 注册 TreeView 和初始化服务
- **package.json**: 定义命令、快捷键、视图和菜单
- **interfaces.ts**: 定义类型接口

## 使用场景

### 场景 1: 代码审查标记
1. 审查代码时发现多处需要优化的地方
2. 使用快捷键在每个位置创建标记
3. 标记自动编号（1, 2, 3...）
4. 审查完成后依次点击标记跳转并处理
5. 完成后归档任务为"代码审查 - 用户模块"

### 场景 2: 调试追踪
1. 调试过程中在多个关键位置创建标记
2. 为每个标记添加描述性文本（如"状态更新点"、"API 调用"）
3. 通过标记快速在各个关键点之间跳转
4. 问题解决后清空当前任务

### 场景 3: 功能开发进度
1. 开始开发新功能时创建标记任务
2. 每个待办事项创建一个标记
3. 完成一项删除一个标记
4. 功能完成后归档任务为"新增支付功能"
5. 后续可以从归档中查看开发过程

## 未来扩展

### 1. 关联功能
- 将标记或任务关联到 Issue
- 在 Issue 中显示相关标记
- 从标记快速跳转到 Issue

### 2. 标记类型
- 支持不同类型的标记（TODO、FIXME、NOTE 等）
- 不同类型使用不同图标和颜色
- 可按类型筛选显示

### 3. 标记搜索
- 在所有标记中搜索
- 按文件、日期、类型筛选
- 全局标记统计

### 4. 团队协作
- 导出/导入标记
- 与 Git 集成，同步标记
- 团队共享标记任务

## 测试建议

1. **基本功能测试**
   - 创建标记（有/无编辑器）
   - 删除标记
   - 重命名标记
   - 拖动排序标记

2. **任务操作测试**
   - 归档任务
   - 清空任务
   - 删除归档
   - 填充归档

3. **边界情况测试**
   - 空任务操作
   - 大量标记性能
   - 无效文件路径处理
   - 快捷键冲突

4. **数据持久化测试**
   - 重启 VS Code 后数据保留
   - 数据文件损坏处理
   - 多工作区数据隔离

## 已知限制

1. 数据存储在全局位置，所有工作区共享
2. 拖放目前只支持单个标记
3. 标记位置在文件修改后可能失效
4. 关联功能尚未实现

## 更新日志

### v1.0.0 (2026-01-03)
- ✅ 初始实现标记管理功能
- ✅ 支持快捷键创建标记
- ✅ 实现 TreeView 展示
- ✅ 支持拖动排序
- ✅ 实现任务归档和填充
- ✅ 添加关联功能占位
