# 笔记映射功能测试指南

本文档提供了笔记映射功能的手动测试步骤。

## 前提条件

1. 确保已配置 `issueManager.issueDir`
2. 插件已安装并激活
3. 至少有一个笔记文件存在

## 测试场景

### 1. 为当前文件创建映射

**步骤：**
1. 在 VS Code 中打开任意文件（例如：一个代码文件）
2. 右键点击编辑器，选择 "映射笔记到当前文件"
3. 在文件选择对话框中选择一个或多个笔记文件
4. 确认映射创建成功的提示消息

**验证：**
- 右键菜单中应该出现 "打开映射的笔记" 选项
- 映射文件 `.issueManager/mappings.yaml` 应该被创建/更新

### 2. 打开映射的笔记

**步骤：**
1. 在已创建映射的文件中，右键点击编辑器
2. 选择 "打开映射的笔记"
3. 如果有多个映射，从 QuickPick 中选择一个

**验证：**
- 选中的笔记文件应该在编辑器中打开

### 3. 绑定工作区笔记

**步骤：**
1. 使用快捷键 `Ctrl+J Ctrl+W` (Windows/Linux) 或 `Cmd+J Cmd+W` (Mac)
2. 选择 "创建新的工作区映射"
3. 选择一个或多个笔记文件
4. 输入优先级（例如：10）
5. 确认创建成功

**验证：**
- 在任意文件中右键，应该能看到 "打开映射的笔记" 选项
- 打开映射的笔记应该显示刚才选择的笔记

### 4. 编辑工作区映射

**步骤：**
1. 使用快捷键 `Ctrl+J Ctrl+W` (Windows/Linux) 或 `Cmd+J Cmd+W` (Mac)
2. 选择 "编辑现有映射"
3. 从列表中选择一个映射
4. 修改优先级
5. 确认更新成功

**验证：**
- 优先级应该被更新
- 打开映射的笔记时应该按新优先级排序

### 5. 删除工作区映射

**步骤：**
1. 使用快捷键 `Ctrl+J Ctrl+W` (Windows/Linux) 或 `Cmd+J Cmd+W` (Mac)
2. 选择 "删除现有映射"
3. 从列表中选择一个映射
4. 确认删除
5. 确认删除成功

**验证：**
- 映射应该从列表中消失
- 在文件中右键应该不再显示该映射

### 6. 编辑映射配置文件

**步骤：**
1. 在命令面板中运行 "编辑笔记映射"
2. 映射文件应该在编辑器中打开
3. 手动修改 YAML 内容（例如：添加新映射、修改优先级）
4. 保存文件

**验证：**
- 修改应该立即生效
- 在文件中右键测试映射功能

### 7. 快捷键测试

**步骤：**
1. 在任意文件中按 `Ctrl+J Ctrl+P` (Windows/Linux) 或 `Cmd+J Cmd+P` (Mac)
2. 如果有映射，应该显示笔记选择器
3. 选择一个笔记

**验证：**
- 选中的笔记应该在编辑器中打开

### 8. 上下文菜单显隐测试

**步骤：**
1. 打开一个没有映射的文件
2. 右键点击编辑器
3. 创建一个映射
4. 再次右键点击编辑器

**验证：**
- 创建映射前，应该只有 "映射笔记到当前文件" 选项
- 创建映射后，应该同时显示 "映射笔记到当前文件" 和 "打开映射的笔记" 选项

### 9. 回退行为测试

**配置：**
在设置中修改 `issueManager.noteMapping.fallbackBehavior`：

**场景 A：fallbackBehavior = "none"**
1. 打开一个没有映射的文件
2. 使用快捷键尝试打开映射的笔记
3. 应该显示 "当前文件没有映射的笔记"

**场景 B：fallbackBehavior = "ask"**
1. 打开一个没有映射的文件
2. 使用快捷键尝试打开映射的笔记
3. 应该询问是否创建映射

### 10. 多映射优先级测试

**步骤：**
1. 为同一个文件创建多个映射（不同优先级）
2. 打开映射的笔记
3. QuickPick 应该按优先级排序显示

**验证：**
- 高优先级的映射应该排在前面

## 配置选项测试

### requireInNoteRoot

**步骤：**
1. 设置 `issueManager.noteMapping.requireInNoteRoot` 为 `true`
2. 尝试选择笔记根目录外的文件作为映射目标
3. 应该显示错误消息

**验证：**
- 不允许映射到笔记根目录外的文件

### autoUpdateContext

**步骤：**
1. 设置 `issueManager.noteMapping.autoUpdateContext` 为 `false`
2. 在文件间切换
3. 右键菜单选项不应该自动更新
4. 设置为 `true` 后重新测试

**验证：**
- 设置为 `true` 时，菜单应该根据当前文件的映射状态动态更新

## 边界条件测试

### 空映射列表
- 尝试编辑/删除映射时，应该显示 "没有工作区级别的映射"

### 多个笔记选择
- 在创建映射时选择多个笔记，所有笔记都应该被添加到映射中

### YAML 格式错误
- 手动破坏 mappings.yaml 文件
- 重新加载插件
- 应该能够恢复或显示错误消息

### 笔记文件不存在
- 创建一个映射，然后删除目标笔记文件
- 尝试打开映射的笔记
- 应该能够处理文件不存在的情况

## 性能测试

### 大量映射
- 创建 100+ 个映射规则
- 测试映射解析的性能
- 测试 QuickPick 的响应速度

### 大笔记库
- 在包含 1000+ 笔记的库中测试
- 验证标题缓存是否正常工作
- 验证 QuickPick 加载速度

## 测试通过标准

- [ ] 所有基本功能正常工作
- [ ] 快捷键响应正确
- [ ] 右键菜单显示正确
- [ ] 配置选项生效
- [ ] 边界条件处理正确
- [ ] 无错误消息或崩溃
- [ ] 性能可接受

## 已知限制

1. 映射文件使用 YAML 格式，手动编辑时需要注意语法
2. glob 模式匹配性能依赖于模式复杂度
3. 标题缓存更新可能有延迟（最多 24 小时）

## 报告问题

如果发现问题，请记录：
1. 复现步骤
2. 预期行为
3. 实际行为
4. 错误消息（如果有）
5. 相关配置设置
